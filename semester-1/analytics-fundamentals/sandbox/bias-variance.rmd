---
title: Examen Final - Bicicletas Electricas
author: Felipe Clement
date: "`r Sys.Date()`"
output:
  pdf_document:
    number_sections: true
    df_print: kable
---

```{r libs, include=FALSE}
library(tidyverse)
```

# Bias variance simulation

Random points will be simulated with a known function, and estimated using splines. The points will be given around $$y\ =\ -3\cos\left(\frac{x-10}{20}\right)+6$$ following a normal distribution.

## Generating data

51 data points are generated by using the function above plus a random error with mean zero and standard deviation 0.5.

```{r generate}
set.seed(1)
f <- function(x) {
  y <- -3 * cos((x - 10) / 20) + 6

  return(y)
}

x <- seq(0, 100, 2)
fx <- f(x)
e <- rnorm(length(x), mean = 0, sd = 0.5)
y <- fx + e

values <- data.frame(
  x = x,
  fx = fx,
  e = e,
  y = y
)

values %>%
  ggplot(aes(x = x)) +
  stat_function(fun = f) +
  geom_point(aes(y = y))
```

## Fitting splines

Splines with degrees of freedom ranging from 2 to 50 are generated.

```{r spline}
create_spline <- function(values, degrees) {
  spline <- smooth.spline(values$x, values$y, df = degrees)

  return(spline)
}

splines_models <- lapply(as.list(2:length(x)), function(degree) {
  create_spline(values, degree)
})
splines <- append(list(NULL), lapply(splines_models, broom::augment))

head(splines[[2]])
```

## Evaluating spline training error

We evaluate each spline fit by calculating the bias and variance for each one, then add those up to calculate the training error.

```{r evaluate}
error_variance <- var(e)

results <- data.frame(
  df = 2:length(x),
  total_error = sapply(2:length(x), function(i) {
    mean(splines[[i]]$.resid^2)
  })
)

results %>%
  ggplot(aes(x = df)) +
  geom_line(aes(y = total_error))
```

## Generating test data

Test data is generated the same way as training data.

```{r test_err}
x_test <- seq(1, 100, 2)
e_test <- rnorm(length(x_test), mean = 0, sd = 0.5)
y_test <- f(x_test) + e_test

values_test <- data.frame(
  x = x_test,
  y = y_test
)

ggplot() +
  geom_point(data = values, aes(x = x, y = y, color = "training")) +
  geom_point(data = values_test, aes(x = x, y = y, color = "test")) 
```

## Evaluating test data

```{r eval_test}
all_predictions <- lapply(as.list(1:length(x_test)), function(i) {
  predictions <-  data.frame(predict(splines_models[[i]], x_test)) %>%
    mutate(
      df = i + 1,
      y_real = y_test,
      resid = y_test - y
    )
  
  return(predictions)
})

all_errors <- bind_rows(lapply(all_predictions, function(data) { 
  err <- data %>%
    group_by(df) %>%
    summarise(
      error = mean(resid ^ 2)
    )

  return(err)
}))

splines[[12]] %>%
  ggplot(aes(x = x)) +
  geom_line(aes(y = .fitted)) +
  geom_point(aes(y = y))

ggplot() +
  geom_line(data = all_errors, aes(x = df, y = error, color = "test")) +
  geom_line(data = results, aes(x = df, y = total_error, color = "training"))
```